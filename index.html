<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡æ¨¡æ¿åŒ– OCR å·¥å…· v2.6</title>
    <!-- å¼•å…¥ Tesseract.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f1f5f9;
            --panel-bg: #ffffff;
            --border-color: #cbd5e1;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --danger-color: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 0.5rem;
            color: var(--text-main);
        }

        h3 {
            margin-top: 0;
        }

        /* é€šç”¨å¡ç‰‡ */
        .step-card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.2s;
        }

        .step-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        .step-header {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .step-title-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-num {
            background: var(--primary-color);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        /* æŒ‰é’®ä½“ç³» */
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .btn-green {
            background-color: #10b981;
        }

        .btn-green:hover {
            background-color: #059669;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }

        .btn-outline:hover {
            background-color: #f8fafc;
            border-color: #94a3b8;
        }

        .btn-danger-outline {
            background-color: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        .btn-danger-outline:hover {
            background-color: #fef2f2;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* è¾“å…¥æ¡†ä¸Select */
        .form-control {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
            outline: none;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5rem;
            cursor: pointer;
        }

        /* æ­¥éª¤1ï¼šæ–‡ä»¶ä¸Šä¼  */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .upload-area:hover,
        .upload-area.drag-over {
            border-color: var(--primary-color);
            background: #eff6ff;
        }

        .upload-hint {
            color: var(--text-sub);
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* æ­¥éª¤1ï¼šæ–‡ä»¶åˆ—è¡¨ */
        .file-list-container {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            margin-top: 10px;
        }

        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
        }

        .file-list-item:last-child {
            border-bottom: none;
        }

        .file-list-item:hover {
            background: #f8fafc;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: hidden;
        }

        .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
            font-weight: 500;
        }

        .file-meta {
            color: var(--text-sub);
            font-size: 12px;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* åˆ—è¡¨æ ·å¼ (ç”¨äºæ­¥éª¤2çš„ç®¡ç†åˆ—è¡¨) */
        .manage-field-list {
            list-style: none;
            padding: 0;
            margin: 15px 0 0 0;
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        @media (min-width: 768px) {
            .manage-field-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .manage-field-item {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .manage-field-item:hover {
            border-color: var(--primary-color);
            background: #fff;
        }

        /* æ–°å¢ï¼šå­—æ®µåºå· Badge */
        .field-index-badge {
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
            min-width: 16px;
            text-align: center;
        }

        /* æ­¥éª¤3ï¼šå¸ƒå±€ */
        .editor-container {
            display: flex;
            gap: 20px;
            height: 600px;
            /* é»˜è®¤é«˜åº¦ */
            transition: height 0.3s;
        }

        .sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            padding-right: 20px;
        }

        .field-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }

        .field-item {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: white;
            transition: all 0.2s;
        }

        .field-item:hover {
            border-color: var(--primary-color);
        }

        .field-item.active {
            background-color: #eff6ff;
            border-color: var(--primary-color);
            border-left-width: 4px;
        }

        .field-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #f1f5f9;
            color: #64748b;
            width: fit-content;
        }

        .field-status.done {
            background: #dcfce7;
            color: #166534;
        }

        /* å³ä¾§ç”»å¸ƒåŒºåŸŸ */
        .main-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #e2e8f0;
            border-radius: 8px;
            position: relative;
        }

        .canvas-toolbar {
            background: white;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-viewport {
            flex: 1;
            overflow: auto;
            position: relative;
            display: flex;
        }

        canvas {
            display: block;
            margin: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            transform-origin: center center;
        }

        .fullscreen-mode {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        .fullscreen-mode .editor-container {
            height: 100%;
        }

        /* è¡¨æ ¼åŒºåŸŸ */
        .table-responsive {
            max-height: 500px;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            text-align: left;
            padding: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover td {
            background-color: #f8fafc;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-section {
            background: #fff7ed;
            border: 1px solid #ffedd5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 5px;
            color: #c2410c;
        }

        progress {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            appearance: none;
        }

        progress::-webkit-progress-bar {
            background-color: #fed7aa;
            border-radius: 5px;
        }

        progress::-webkit-progress-value {
            background-color: #f97316;
            border-radius: 5px;
            transition: width 0.3s;
        }

        /* è‡ªå®šä¹‰ Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            width: 400px;
            max-width: 90%;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: modalPop 0.2s ease-out;
        }

        @keyframes modalPop {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .modal-content {
            color: #4b5563;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            margin-top: 10px;
            box-sizing: border-box;
        }

        /* åŠ è½½é®ç½© */
        #globalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ğŸ“„ æ‰¹é‡æ¨¡æ¿åŒ– OCR å·¥å…· v2.6</h1>
        <p style="color: var(--text-sub); margin-bottom: 30px;">
            ä»…éœ€ä¸‰æ­¥ï¼šå¯¼å…¥å›¾ç‰‡ â†’ ç”»æ¡†å®šä¹‰æ¨¡æ¿ â†’ æ‰¹é‡å¯¼å‡ºæ•°æ®
        </p>

        <!-- æ­¥éª¤ 1 -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-title-group">
                    <div class="step-num">1</div> å¯¼å…¥å›¾ç‰‡
                </div>
                <button class="btn btn-outline btn-sm" onclick="clearAllFiles()" id="clearAllBtn"
                    style="display:none;">ğŸ—‘ï¸ æ¸…ç©ºåˆ—è¡¨</button>
            </div>

            <div class="upload-area" id="dropZone">
                <div style="font-size: 2rem;">ğŸ“‚</div>
                <div style="font-weight: 500; font-size: 1.1rem; margin:10px 0;">æ‹–æ‹½æ–‡ä»¶/æ–‡ä»¶å¤¹åˆ°æ­¤å¤„</div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-outline" onclick="triggerFileSelect('folder')">é€‰æ‹©æ–‡ä»¶å¤¹</button>
                    <button class="btn btn-outline" onclick="triggerFileSelect('file')">é€‰æ‹©æ–‡ä»¶ (å¤šé€‰)</button>
                </div>
                <input type="file" id="folderInput" webkitdirectory multiple style="display:none">
                <input type="file" id="filesInput" multiple style="display:none">
            </div>

            <div id="fileListArea" style="display:none;">
                <div id="groupInfo" style="margin-bottom: 10px; font-weight: 600;"></div>
                <div class="file-list-container" id="fileListEl">
                    <!-- æ–‡ä»¶åˆ—è¡¨ -->
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤ 2 -->
        <div class="step-card" id="step2" style="display:none;">
            <div class="step-header">
                <div class="step-title-group">
                    <div class="step-num">2</div> å®šä¹‰è¯†åˆ«å­—æ®µ & æ¨¡æ¿é…ç½®
                </div>
                <div>
                    <input type="file" id="configFileImport" accept=".json" style="display:none"
                        onchange="importConfig(this)">
                    <button class="btn btn-outline btn-sm"
                        onclick="document.getElementById('configFileImport').click()">ğŸ“‚ å¯¼å…¥é…ç½®</button>
                    <button class="btn btn-outline btn-sm" onclick="exportConfig()">ğŸ’¾ å¯¼å‡ºé…ç½®</button>
                </div>
            </div>

            <div style="display:flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="newFieldInput" class="form-control" placeholder="è¾“å…¥å­—æ®µID (å¦‚: å‘ç¥¨å·, æ—¥æœŸ) - æŒ‰å›è½¦æ·»åŠ "
                    style="width: 300px;">
                <button class="btn" onclick="addField()">+ æ·»åŠ å­—æ®µ</button>
            </div>

            <div style="background: #f1f5f9; padding: 15px; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: var(--text-sub);">å·²å®šä¹‰å­—æ®µ (ç®¡ç† - å¯æ‹–æ‹½æ’åº)</h4>
                <div id="emptyFieldHint" style="color:#94a3b8; font-size:13px; font-style:italic;">æš‚æ— å­—æ®µï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ </div>
                <ul class="manage-field-list" id="manageFieldList"></ul>
            </div>
        </div>

        <!-- æ­¥éª¤ 3 -->
        <div class="step-card" id="step3" style="display:none;">
            <div class="step-header">
                <div class="step-title-group">
                    <div class="step-num">3</div> è®¾å®šè¯†åˆ«åŒºåŸŸ
                </div>
                <button class="btn btn-outline btn-sm" onclick="toggleFullscreen()">â›¶ å…¨å±/æœ€å¤§åŒ–ç¼–è¾‘</button>
            </div>

            <div
                style="background: #fff7ed; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffedd5;">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <span style="font-weight:600; color:#c2410c;">å½“å‰å°ºå¯¸ç»„: </span>
                        <select id="groupSelect" class="form-control" style="padding: 4px 24px 4px 8px; height: 32px;"
                            onchange="switchGroup()"></select>
                    </div>
                    <div style="font-size:12px; color:#ea580c;">âš ï¸ æç¤ºï¼šæ‰€æœ‰è¯†åˆ«æ¡†å‡å¯ç›´æ¥è°ƒæ•´å¤§å°</div>
                </div>
            </div>

            <div class="editor-container">
                <div class="sidebar">
                    <h4 style="margin: 0 0 10px 0; color: var(--text-sub); font-size:12px; text-transform: uppercase;">
                        é€‰æ‹©å­—æ®µè¿›è¡Œç”»æ¡†</h4>
                    <ul class="field-list" id="drawingSelectorList"></ul>
                </div>

                <div class="main-stage">
                    <div class="canvas-toolbar">
                        <div style="font-size:12px; font-weight:600; color:var(--text-sub);">CANVAS</div>
                        <div style="display:flex; gap: 5px; align-items: center;">
                            <button class="btn btn-outline btn-sm" onclick="adjustZoom(-0.1)">-</button>
                            <span id="zoomLabel" style="font-size:12px; min-width: 40px; text-align:center;">100%</span>
                            <button class="btn btn-outline btn-sm" onclick="adjustZoom(0.1)">+</button>
                            <button class="btn btn-outline btn-sm" onclick="resetZoom()">é‡ç½®</button>
                        </div>
                    </div>
                    <div class="canvas-viewport" id="canvasContainer">
                        <!-- Canvas -->
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤ 4 -->
        <div class="step-card" id="step4" style="display:none;">
            <div class="step-header">
                <div class="step-title-group">
                    <div class="step-num">4</div> æ‰¹é‡è¯†åˆ«ä¸å¯¼å‡º
                </div>
            </div>
            <div style="display:flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                <select id="langSelect" class="form-control" style="width: 200px;">
                    <option value="eng">è‹±è¯­ (English)</option>
                    <option value="chi_sim">ç®€ä½“ä¸­æ–‡ (Simple)</option>
                    <option value="chi_tra">ç¹ä½“ä¸­æ–‡ (Traditional)</option>
                    <option value="jpn">æ—¥è¯­ (Japanese)</option>
                </select>
                <button class="btn btn-green" id="startBtn" onclick="startBatchOCR()">ğŸš€ å¼€å§‹æ‰¹é‡è¯†åˆ«</button>
                <button class="btn" onclick="downloadCSV()" id="dlBtn" disabled>ğŸ’¾ ä¸‹è½½ CSV</button>
            </div>
            <div id="inlineProgress" class="progress-section">
                <div class="progress-label">
                    <span style="font-weight:600" id="progressStatus">æ­£åœ¨å¤„ç†...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <progress id="batchProgressBar" value="0" max="100"></progress>
                <div id="progressFilename" style="font-size:12px; color:#c2410c; margin-top:5px; text-align:right;">
                </div>
            </div>
            <div class="table-responsive">
                <table class="result-table">
                    <thead id="resultHead"></thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ Modal -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modalTitle">æ ‡é¢˜</div>
            <div class="modal-content" id="modalContent">å†…å®¹</div>
            <input type="text" id="modalInput" class="modal-input" style="display:none;">
            <div class="modal-actions" style="margin-top:20px;">
                <button class="btn btn-outline" id="modalCancelBtn">å–æ¶ˆ</button>
                <button class="btn" id="modalOkBtn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div id="globalOverlay">
        <div class="spinner"></div>
        <h3 style="margin-top: 20px;">æ­£åœ¨å¤„ç†...</h3>
        <p style="color:#666">è¯·ç¨å€™</p>
    </div>

    <script>
        // --- çŠ¶æ€ç®¡ç† ---
        const state = {
            images: [], // { id, file, width, height, groupKey, url }
            groups: {},
            fields: [],
            templates: {},
            currentGroupKey: null,
            activeField: null,
            results: [],
            zoom: 1.0,
            isFullscreen: false
        };

        // äº¤äº’çŠ¶æ€
        const interaction = {
            mode: null, // 'draw', 'move', 'resize', null
            targetField: null,
            startPos: { x: 0, y: 0 },
            initialRect: null
        };

        // --- DOM å¼•ç”¨ ---
        const UI = {
            dropZone: document.getElementById('dropZone'),
            folderInput: document.getElementById('folderInput'),
            filesInput: document.getElementById('filesInput'),
            fileListArea: document.getElementById('fileListArea'),
            fileListEl: document.getElementById('fileListEl'),
            clearAllBtn: document.getElementById('clearAllBtn'),
            groupInfo: document.getElementById('groupInfo'),

            step2: document.getElementById('step2'),
            step3: document.getElementById('step3'),
            step4: document.getElementById('step4'),

            manageFieldList: document.getElementById('manageFieldList'),
            drawingSelectorList: document.getElementById('drawingSelectorList'),
            emptyFieldHint: document.getElementById('emptyFieldHint'),

            canvasContainer: document.getElementById('canvasContainer'),
            groupSelect: document.getElementById('groupSelect'),
            zoomLabel: document.getElementById('zoomLabel'),

            inlineProgress: document.getElementById('inlineProgress'),
            progressStatus: document.getElementById('progressStatus'),
            progressBar: document.getElementById('batchProgressBar'),
            progressPercent: document.getElementById('progressPercent'),
            progressFilename: document.getElementById('progressFilename'),
            globalOverlay: document.getElementById('globalOverlay')
        };

        let canvas, ctx, currentImageElement;

        // --- 1. Modal ç³»ç»Ÿ ---
        const Modal = {
            el: document.getElementById('customModal'),
            title: document.getElementById('modalTitle'),
            content: document.getElementById('modalContent'),
            input: document.getElementById('modalInput'),
            okBtn: document.getElementById('modalOkBtn'),
            cancelBtn: document.getElementById('modalCancelBtn'),
            resolve: null,
            show(options) {
                this.title.innerText = options.title || 'æç¤º';
                this.content.innerText = options.text || '';
                this.input.style.display = options.type === 'prompt' ? 'block' : 'none';
                this.input.value = options.defaultValue || '';
                this.cancelBtn.style.display = options.type === 'alert' ? 'none' : 'block';
                this.el.style.display = 'flex';
                if (options.type === 'prompt') this.input.focus();
                return new Promise((resolve) => {
                    this.resolve = resolve;
                    this.okBtn.onclick = () => this.close(true);
                    this.cancelBtn.onclick = () => this.close(false);
                    if (options.type === 'prompt') this.input.onkeydown = (e) => { if (e.key === 'Enter') this.close(true); };
                });
            },
            close(isOk) {
                this.el.style.display = 'none';
                if (this.resolve) {
                    if (this.input.style.display !== 'none') this.resolve(isOk ? this.input.value : null);
                    else this.resolve(isOk);
                }
            }
        };
        const customAlert = (text) => Modal.show({ type: 'alert', title: 'æç¤º', text });
        const customConfirm = (text) => Modal.show({ type: 'confirm', title: 'ç¡®è®¤', text });
        const customPrompt = (text, defaultVal) => Modal.show({ type: 'prompt', title: 'è¾“å…¥', text, defaultValue: defaultVal });

        // --- 2. å¢å¼ºçš„æ–‡ä»¶å¤„ç† ---

        function triggerFileSelect(type) {
            if (type === 'folder') UI.folderInput.click();
            else UI.filesInput.click();
        }

        // æ‹–æ‹½
        UI.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); UI.dropZone.classList.add('drag-over'); });
        UI.dropZone.addEventListener('dragleave', () => { UI.dropZone.classList.remove('drag-over'); });
        UI.dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            UI.dropZone.classList.remove('drag-over');
            const items = e.dataTransfer.items;
            if (!items || items.length === 0) return;

            UI.globalOverlay.style.display = 'flex';
            const files = [];
            const queue = [];
            for (let i = 0; i < items.length; i++) {
                const entry = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
                if (entry) queue.push(entry);
                else if (items[i].kind === 'file') files.push(items[i].getAsFile()); // Fallback
            }

            while (queue.length > 0) {
                const entry = queue.shift();
                if (entry.isFile) {
                    const file = await new Promise(r => entry.file(r));
                    if (file.type.startsWith('image/')) files.push(file);
                } else if (entry.isDirectory) {
                    const reader = entry.createReader();
                    const entries = await new Promise(r => reader.readEntries(r));
                    queue.push(...entries);
                }
            }
            await addFiles(files);
        });

        // Input Change
        const handleFiles = async (e) => {
            const files = Array.from(e.target.files).filter(f => f.type.startsWith('image/'));
            UI.globalOverlay.style.display = 'flex';
            await addFiles(files);
            e.target.value = ''; // Reset
        };
        UI.folderInput.addEventListener('change', handleFiles);
        UI.filesInput.addEventListener('change', handleFiles);

        async function addFiles(files) {
            if (files.length === 0) {
                UI.globalOverlay.style.display = 'none';
                if (state.images.length === 0) customAlert("æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶");
                return;
            }

            let addedCount = 0;
            for (let file of files) {
                try {
                    const dim = await getImageDimensions(file);
                    const key = `${dim.w}x${dim.h}`;
                    const id = Date.now() + Math.random().toString(36).substr(2, 9);

                    const imgObj = { id, file, width: dim.w, height: dim.h, groupKey: key, url: dim.url };

                    state.images.push(imgObj);
                    if (!state.groups[key]) state.groups[key] = [];
                    state.groups[key].push(imgObj);

                    // ç¡®ä¿æ¨¡æ¿ key å­˜åœ¨
                    if (!state.templates[key]) state.templates[key] = {};

                    addedCount++;
                } catch (err) { console.warn("Skipped", file.name); }
            }

            UI.globalOverlay.style.display = 'none';
            refreshUI();

            // è‡ªåŠ¨è·³è½¬æ­¥éª¤
            if (state.images.length > 0) {
                UI.fileListArea.style.display = 'block';
                UI.clearAllBtn.style.display = 'block';
                UI.step2.style.display = 'block';
                if (state.fields.length > 0) {
                    renderFieldLists();
                    UI.step3.style.display = 'block';
                    // å¦‚æœæ˜¯é¦–æ¬¡æ·»åŠ ï¼Œé€‰ä¸­ç¬¬ä¸€ä¸ªç»„
                    if (!state.currentGroupKey && Object.keys(state.groups).length > 0) {
                        UI.groupSelect.value = Object.keys(state.groups)[0];
                        switchGroup();
                    } else if (state.currentGroupKey) {
                        renderGroupInfo();
                    }
                }
            }
        }

        function getImageDimensions(file) {
            return new Promise((resolve, reject) => {
                const url = URL.createObjectURL(file);
                const img = new Image();
                img.onload = () => resolve({ w: img.naturalWidth, h: img.naturalHeight, url: url });
                img.onerror = reject;
                img.src = url;
            });
        }

        function removeFile(id) {
            const idx = state.images.findIndex(img => img.id === id);
            if (idx === -1) return;
            const img = state.images[idx];

            // Remove from list
            state.images.splice(idx, 1);

            // Remove from group
            const group = state.groups[img.groupKey];
            const gIdx = group.findIndex(gImg => gImg.id === id);
            if (gIdx > -1) group.splice(gIdx, 1);

            // Check if group empty
            if (group.length === 0) {
                delete state.groups[img.groupKey];
                if (state.currentGroupKey === img.groupKey) {
                    const remainingKeys = Object.keys(state.groups);
                    if (remainingKeys.length > 0) {
                        UI.groupSelect.value = remainingKeys[0];
                        switchGroup();
                    } else {
                        state.currentGroupKey = null;
                        UI.canvasContainer.innerHTML = '';
                        UI.step3.style.display = 'none';
                    }
                }
            }

            refreshUI();
            if (state.images.length === 0) clearAllFiles();
        }

        function clearAllFiles() {
            state.images = [];
            state.groups = {};
            state.currentGroupKey = null;
            refreshUI();
            UI.fileListArea.style.display = 'none';
            UI.clearAllBtn.style.display = 'none';
            UI.step3.style.display = 'none';
            UI.step4.style.display = 'none';
            UI.canvasContainer.innerHTML = '';
        }

        function refreshUI() {
            renderGroupInfo();
            renderFileList();
        }

        function renderGroupInfo() {
            const keys = Object.keys(state.groups);
            let html = `å½“å‰å…± ${state.images.length} å¼ å›¾ç‰‡ï¼Œåˆ†ä¸º ${keys.length} ç±»å°ºå¯¸: `;
            keys.forEach(k => {
                html += `<span style="background:#e2e8f0; padding:2px 6px; margin-right:5px; border-radius:4px; font-weight:normal; font-size:12px;">${k} (${state.groups[k].length})</span>`;
            });
            UI.groupInfo.innerHTML = html;

            // Update Select
            const oldKey = UI.groupSelect.value;
            UI.groupSelect.innerHTML = keys.map(k => `<option value="${k}">${k}</option>`).join('');
            if (keys.includes(oldKey)) UI.groupSelect.value = oldKey;
        }

        function renderFileList() {
            UI.fileListEl.innerHTML = state.images.map(img => `
            <div class="file-list-item">
                <div class="file-info">
                    <span class="file-meta">${img.width}x${img.height}</span>
                    <span class="file-name" title="${img.file.name}">${img.file.name}</span>
                </div>
                <button class="btn btn-outline btn-sm" style="color:#ef4444; border:none; padding:2px 6px;" onclick="removeFile('${img.id}')">âœ•</button>
            </div>
        `).join('');
        }

        // --- 3. å­—æ®µç®¡ç† (å«æ’åºåŠŸèƒ½) ---

        document.getElementById('newFieldInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') addField(); });

        function addField() {
            const input = document.getElementById('newFieldInput');
            const val = input.value.trim();
            if (!val) return;
            if (state.fields.includes(val)) return customAlert("å­—æ®µå·²å­˜åœ¨");
            state.fields.push(val);
            input.value = '';
            renderFieldLists();
            if (state.images.length > 0) {
                UI.step3.style.display = 'block';
                if (!state.currentGroupKey && Object.keys(state.groups).length > 0) {
                    UI.groupSelect.value = Object.keys(state.groups)[0];
                    switchGroup();
                }
            }
        }

        function moveField(fieldName, direction) {
            const idx = state.fields.indexOf(fieldName);
            if (idx === -1) return;

            // è¾¹ç•Œæ£€æŸ¥
            if (direction === -1 && idx === 0) return; // å·²ç»åœ¨æœ€ä¸Šé¢
            if (direction === 1 && idx === state.fields.length - 1) return; // å·²ç»åœ¨æœ€ä¸‹é¢

            // äº¤æ¢
            const temp = state.fields[idx];
            state.fields[idx] = state.fields[idx + direction];
            state.fields[idx + direction] = temp;

            renderFieldLists();
        }

        function renderFieldLists() {
            UI.emptyFieldHint.style.display = state.fields.length === 0 ? 'block' : 'none';
            UI.manageFieldList.innerHTML = state.fields.map((f, index) => `
            <li class="manage-field-item">
                <div style="display:flex; align-items:center;">
                    <span class="field-index-badge">#${index + 1}</span>
                    <span style="font-weight:500;">${f}</span>
                </div>
                <div style="display:flex; gap:5px; align-items:center;">
                    <div style="margin-right:8px; display:flex; gap:2px;">
                        <button class="btn btn-outline btn-sm" style="padding:2px 5px;" 
                            onclick="moveField('${f}', -1)" ${index === 0 ? 'disabled' : ''} title="ä¸Šç§»">â†‘</button>
                        <button class="btn btn-outline btn-sm" style="padding:2px 5px;" 
                            onclick="moveField('${f}', 1)" ${index === state.fields.length - 1 ? 'disabled' : ''} title="ä¸‹ç§»">â†“</button>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="editField('${f}')">âœï¸</button>
                    <button class="btn btn-outline btn-sm" style="color:#ef4444;" onclick="deleteField('${f}')">ğŸ—‘ï¸</button>
                </div>
            </li>
        `).join('');

            UI.drawingSelectorList.innerHTML = state.fields.map(f => {
                const isSet = isFieldConfigured(f);
                return `
            <li class="field-item ${state.activeField === f ? 'active' : ''}" onclick="selectField('${f}')">
                <span style="font-weight:600; font-size:14px;">${f}</span>
                <div class="field-status ${isSet ? 'done' : ''}">${isSet ? 'âœ… å·²è®¾å®š' : 'âšª æœªè®¾å®š'}</div>
            </li>
            `;
            }).join('');

            if (state.activeField && !state.fields.includes(state.activeField)) state.activeField = null;
        }

        async function deleteField(fieldName) {
            if (!await customConfirm(`ç¡®å®šè¦åˆ é™¤å­—æ®µ "${fieldName}" å—ï¼Ÿ`)) return;
            state.fields = state.fields.filter(f => f !== fieldName);
            for (let key in state.templates) if (state.templates[key][fieldName]) delete state.templates[key][fieldName];
            renderFieldLists();
            drawCanvas();
            checkStep4Visibility();
        }

        async function editField(oldName) {
            const newName = await customPrompt("è¯·è¾“å…¥æ–°åç§°:", oldName);
            if (!newName || newName === oldName) return;
            if (state.fields.includes(newName)) return customAlert("å­—æ®µåå·²å­˜åœ¨");
            const idx = state.fields.indexOf(oldName);
            state.fields[idx] = newName;
            for (let key in state.templates) {
                if (state.templates[key][oldName]) {
                    state.templates[key][newName] = state.templates[key][oldName];
                    delete state.templates[key][oldName];
                }
            }
            if (state.activeField === oldName) state.activeField = newName;
            renderFieldLists();
            drawCanvas();
        }

        // --- 4. Canvas äº¤äº’ (å‡çº§ç‰ˆ: æ‹–æ‹½ä¸ç¼©æ”¾) ---

        function switchGroup() {
            state.currentGroupKey = UI.groupSelect.value;
            const groupImages = state.groups[state.currentGroupKey];
            if (!groupImages || groupImages.length === 0) return;
            initCanvas(groupImages[0]);
            renderFieldLists();
            checkStep4Visibility();
        }

        // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºç¬¬å››æ­¥
        function checkStep4Visibility() {
            // åªè¦å½“å‰ç»„æœ‰ä»»ä½•ä¸€ä¸ªå·²è®¾å®šçš„æ¨¡æ¿ï¼Œå°±æ˜¾ç¤ºç¬¬å››æ­¥
            if (state.currentGroupKey && state.templates[state.currentGroupKey]) {
                const hasTemplates = Object.keys(state.templates[state.currentGroupKey]).length > 0;
                UI.step4.style.display = hasTemplates ? 'block' : 'none';
            } else {
                UI.step4.style.display = 'none';
            }
        }

        function toggleFullscreen() {
            state.isFullscreen = !state.isFullscreen;
            document.getElementById('step3').classList.toggle('fullscreen-mode', state.isFullscreen);
            document.body.style.overflow = state.isFullscreen ? 'hidden' : '';
        }

        function initCanvas(imgObj) {
            UI.canvasContainer.innerHTML = '';
            canvas = document.createElement('canvas');
            ctx = canvas.getContext('2d');
            canvas.width = imgObj.width; canvas.height = imgObj.height;
            UI.canvasContainer.appendChild(canvas);

            currentImageElement = new Image();
            currentImageElement.onload = () => {
                const containerW = UI.canvasContainer.clientWidth;
                state.zoom = imgObj.width > containerW ? (containerW - 40) / imgObj.width : 1.0;
                applyZoom();
            };
            currentImageElement.src = imgObj.url;

            canvas.addEventListener('mousedown', onMouseDown);
            window.addEventListener('mouseup', onMouseUp);
            canvas.addEventListener('mousemove', onMouseMove);
            UI.canvasContainer.addEventListener('wheel', handleWheel, { passive: false });
        }

        function applyZoom() {
            if (!canvas) return;
            canvas.style.width = (canvas.width * state.zoom) + 'px';
            canvas.style.height = (canvas.height * state.zoom) + 'px';
            UI.zoomLabel.innerText = Math.round(state.zoom * 100) + '%';
            drawCanvas();
        }

        function handleWheel(e) { if (e.ctrlKey || e.metaKey) { e.preventDefault(); adjustZoom(e.deltaY > 0 ? -0.1 : 0.1); } }
        function adjustZoom(delta) { state.zoom = Math.max(0.1, Math.min(5.0, state.zoom + delta)); applyZoom(); }
        function resetZoom() { state.zoom = 1.0; applyZoom(); }

        function getCanvasPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        // ç»˜åˆ¶é€»è¾‘
        function drawCanvas() {
            if (!ctx || !currentImageElement) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImageElement, 0, 0);
            ctx.fillStyle = "rgba(0, 0, 0, 0.3)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const tmpl = state.templates[state.currentGroupKey] || {};

            // ç»˜åˆ¶æ‰€æœ‰æ¡†
            for (let field of state.fields) {
                if (tmpl[field]) {
                    const isActive = (field === state.activeField);
                    // ç¡®ä¿æ´»åŠ¨æ¡†ç»˜åˆ¶åœ¨æœ€ä¸Šå±‚
                    if (isActive) continue;
                    drawRect(tmpl[field], field, false);
                }
            }
            // æœ€åç»˜åˆ¶æ´»åŠ¨æ¡†
            if (state.activeField && tmpl[state.activeField]) {
                drawRect(tmpl[state.activeField], state.activeField, true);
            }
        }

        function drawRect(rect, label, isActive) {
            ctx.strokeStyle = isActive ? "#ef4444" : "#2563eb";
            ctx.lineWidth = isActive ? 4 : 2;
            ctx.setLineDash(isActive ? [] : [5, 5]);

            // æ¸…é™¤å†…éƒ¨é®ç½©
            ctx.clearRect(rect.x, rect.y, rect.w, rect.h);
            ctx.drawImage(currentImageElement, rect.x, rect.y, rect.w, rect.h, rect.x, rect.y, rect.w, rect.h);

            // è¾¹æ¡†å’Œé«˜äº®èƒŒæ™¯
            ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
            ctx.setLineDash([]);
            ctx.fillStyle = isActive ? "rgba(239, 68, 68, 0.1)" : "rgba(37, 99, 235, 0.1)";
            ctx.fillRect(rect.x, rect.y, rect.w, rect.h);

            // æ ‡ç­¾ (ç”¨ä½œç§»åŠ¨æ‰‹æŸ„)
            ctx.font = "bold 24px Arial";
            const textWidth = ctx.measureText(label).width;
            ctx.fillStyle = isActive ? "#ef4444" : "#2563eb";
            // æ ‡ç­¾èƒŒæ™¯ï¼šå¦‚æœåœ¨é¡¶éƒ¨è¾¹ç¼˜ï¼Œç”»åœ¨é‡Œé¢ï¼Œå¦åˆ™ç”»åœ¨ä¸Šé¢
            const labelY = rect.y - 30 < 0 ? rect.y : rect.y - 30;
            ctx.fillRect(rect.x, labelY, textWidth + 10, 30);

            ctx.fillStyle = "#ffffff";
            ctx.fillText(label, rect.x + 5, labelY + 22);

            // è°ƒæ•´å¤§å°æ‰‹æŸ„ (Always Show)
            const handleSize = 15;
            // æœªé€‰ä¸­æ—¶ç”¨æµ…è‰²ï¼Œé€‰ä¸­æ—¶ç”¨ç™½è‰²
            ctx.fillStyle = isActive ? "#ffffff" : "#cbd5e1";
            ctx.fillRect(rect.x + rect.w - handleSize, rect.y + rect.h - handleSize, handleSize, handleSize);
            ctx.strokeStyle = isActive ? "#ef4444" : "#2563eb";
            ctx.strokeRect(rect.x + rect.w - handleSize, rect.y + rect.h - handleSize, handleSize, handleSize);

            // æ–œçº¿è£…é¥°
            ctx.beginPath();
            ctx.moveTo(rect.x + rect.w - handleSize + 3, rect.y + rect.h - 3);
            ctx.lineTo(rect.x + rect.w - 3, rect.y + rect.h - handleSize + 3);
            ctx.stroke();
        }

        // å‘½ä¸­æ£€æµ‹
        function getHitTarget(pos) {
            const tmpl = state.templates[state.currentGroupKey];
            if (!tmpl) return null;

            // ä¼˜åŒ–ï¼šåå‘éå†ï¼ˆä»æœ€ä¸Šå±‚å›¾å±‚å¼€å§‹æ£€æµ‹ï¼‰
            // è¿™æ ·å¦‚æœæ¡†é‡å ï¼Œä¼šä¼˜å…ˆé€‰ä¸­è§†è§‰ä¸Šåœ¨æœ€ä¸Šé¢çš„é‚£ä¸ª
            const reverseFields = [...state.fields].reverse();

            // 1. ä¼˜å…ˆæ£€æŸ¥ Resize Handles
            for (let field of reverseFields) {
                const rect = tmpl[field];
                if (!rect) continue;
                // æ‰©å¤§ä¸€ç‚¹åˆ¤å®šèŒƒå›´æ–¹ä¾¿ç‚¹å‡»
                if (pos.x >= rect.x + rect.w - 20 && pos.x <= rect.x + rect.w + 10 &&
                    pos.y >= rect.y + rect.h - 20 && pos.y <= rect.y + rect.h + 10) {
                    return { type: 'resize', field: field };
                }
            }

            // 2. æ£€æŸ¥ç§»åŠ¨åŒºåŸŸ (Label)
            for (let field of reverseFields) {
                const rect = tmpl[field];
                if (!rect) continue;

                ctx.font = "bold 24px Arial";
                const textWidth = ctx.measureText(field).width;
                const labelY = rect.y - 30 < 0 ? rect.y : rect.y - 30;

                // æ ‡ç­¾åŒºåŸŸ
                if (pos.x >= rect.x && pos.x <= rect.x + textWidth + 10 &&
                    pos.y >= labelY && pos.y <= labelY + 30) {
                    return { type: 'move', field };
                }
            }

            return null;
        }

        function onMouseDown(e) {
            const pos = getCanvasPos(e);
            const target = getHitTarget(pos);

            if (target) {
                // å‘½ä¸­æ‰‹æŸ„æˆ–æ ‡ç­¾ï¼Œè¿›å…¥ç¼–è¾‘æ¨¡å¼
                interaction.mode = target.type;
                interaction.targetField = target.field;
                interaction.startPos = { ...pos };

                // è‡ªåŠ¨é€‰ä¸­è¯¥å­—æ®µ (ä¼˜åŒ–ä½“éªŒ)
                state.activeField = target.field;
                renderFieldLists();

                const rect = state.templates[state.currentGroupKey][target.field];
                interaction.initialRect = { ...rect }; // å¿«ç…§
                drawCanvas();
                return;
            }

            // æœªå‘½ä¸­ä»»ä½•æ‰‹æŸ„ï¼Œä¸”æœ‰æ´»åŠ¨å­—æ®µï¼Œå¼€å§‹ç”»æ–°æ¡†
            if (state.activeField) {
                interaction.mode = 'draw';
                interaction.startPos = { ...pos };
                return;
            }

            customAlert("è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©è¦æ“ä½œçš„å­—æ®µï¼");
        }

        function onMouseMove(e) {
            const pos = getCanvasPos(e);

            // æ›´æ–°å…‰æ ‡æ ·å¼
            if (!interaction.mode) {
                const target = getHitTarget(pos);
                if (target) {
                    canvas.style.cursor = target.type === 'resize' ? 'nwse-resize' : 'move';
                } else {
                    canvas.style.cursor = state.activeField ? 'crosshair' : 'default';
                }
                return;
            }

            const dx = pos.x - interaction.startPos.x;
            const dy = pos.y - interaction.startPos.y;

            if (interaction.mode === 'move') {
                const rect = interaction.initialRect;
                const newRect = { ...rect, x: rect.x + dx, y: rect.y + dy };
                state.templates[state.currentGroupKey][interaction.targetField] = newRect;
                drawCanvas();
            }
            else if (interaction.mode === 'resize') {
                const rect = interaction.initialRect;
                // ä¿æŒ w, h > 5
                const newW = Math.max(5, rect.w + dx);
                const newH = Math.max(5, rect.h + dy);
                const newRect = { ...rect, w: newW, h: newH };
                state.templates[state.currentGroupKey][interaction.targetField] = newRect;
                drawCanvas();
            }
            else if (interaction.mode === 'draw') {
                drawCanvas(); // é‡ç»˜åº•å›¾
                const w = pos.x - interaction.startPos.x;
                const h = pos.y - interaction.startPos.y;
                ctx.strokeStyle = "#ef4444";
                ctx.lineWidth = 4;
                ctx.strokeRect(interaction.startPos.x, interaction.startPos.y, w, h);
            }
        }

        function onMouseUp(e) {
            if (!interaction.mode) return;

            if (interaction.mode === 'draw') {
                const pos = getCanvasPos(e);
                let w = pos.x - interaction.startPos.x;
                let h = pos.y - interaction.startPos.y;
                let x = interaction.startPos.x;
                let y = interaction.startPos.y;

                if (w < 0) { x += w; w = Math.abs(w); }
                if (h < 0) { y += h; h = Math.abs(h); }

                if (w > 5 && h > 5) {
                    if (!state.templates[state.currentGroupKey]) state.templates[state.currentGroupKey] = {};
                    state.templates[state.currentGroupKey][state.activeField] = { x, y, w, h };
                    renderFieldLists();
                }
            } else {
                // move or resize ended
            }

            interaction.mode = null;
            interaction.initialRect = null;
            drawCanvas();
            checkStep4Visibility(); // ç»Ÿä¸€æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºä¸‹ä¸€æ­¥
        }

        // --- 5. é…ç½®ä¸æ‰¹é‡ (ä¿æŒä¸å˜) ---
        function isFieldConfigured(field) {
            if (!state.currentGroupKey) return false;
            return state.templates[state.currentGroupKey] && state.templates[state.currentGroupKey][field];
        }
        function selectField(f) { state.activeField = f; renderFieldLists(); drawCanvas(); }

        function exportConfig() {
            if (state.fields.length === 0) return customAlert("æ— é…ç½®å¯å¯¼å‡º");
            const configData = { version: "2.4", timestamp: new Date().toISOString(), fields: state.fields, templates: state.templates };
            const blob = new Blob([JSON.stringify(configData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = `ocr_config_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        async function importConfig(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const config = JSON.parse(e.target.result);
                    if (!config.fields || !config.templates) throw new Error("æ ¼å¼é”™è¯¯");
                    if (await customConfirm("å¯¼å…¥å°†è¦†ç›–å½“å‰é…ç½®ï¼Œç¡®å®šå—ï¼Ÿ")) {
                        state.fields = config.fields;
                        state.templates = config.templates;
                        // è¡¥å…¨å½“å‰å›¾ç‰‡çš„ key
                        Object.keys(state.groups).forEach(k => { if (!state.templates[k]) state.templates[k] = {}; });

                        renderFieldLists();

                        // ä¿®å¤ï¼šå¦‚æœæœ‰å›¾ç‰‡ï¼Œå¼ºåˆ¶é€‰ä¸­ç¬¬ä¸€ä¸ªç»„å¹¶åˆ·æ–°ç”»å¸ƒçŠ¶æ€
                        if (state.images.length > 0) {
                            UI.step3.style.display = 'block';
                            // å¦‚æœå½“å‰æ²¡é€‰ä¸­ç»„ï¼Œé»˜è®¤é€‰ç¬¬ä¸€ä¸ª
                            if (!state.currentGroupKey && Object.keys(state.groups).length > 0) {
                                UI.groupSelect.value = Object.keys(state.groups)[0];
                            }
                            // å¼ºåˆ¶è°ƒç”¨ switchGroup ä»¥åˆ·æ–°ç”»å¸ƒå’Œæ£€æµ‹çŠ¶æ€
                            switchGroup();
                        }

                        checkStep4Visibility();
                        customAlert(`å·²å¯¼å…¥ ${state.fields.length} ä¸ªå­—æ®µ`);
                    }
                } catch (err) { customAlert("å¤±è´¥: " + err.message); }
                finally { input.value = ''; }
            };
            reader.readAsText(file);
        }

        async function startBatchOCR() {
            for (let groupKey of Object.keys(state.groups)) {
                const tmpl = state.templates[groupKey];
                if (state.groups[groupKey].length > 0) {
                    const missing = state.fields.filter(f => !tmpl[f]);
                    if (missing.length > 0) {
                        if (!await customConfirm(`âš ï¸ ç»„ [${groupKey}] ç¼ºå°‘ [${missing.join(', ')}]ï¼Œè·³è¿‡å—ï¼Ÿ`)) return;
                    }
                }
            }

            document.getElementById('startBtn').disabled = true;
            UI.inlineProgress.style.display = 'block';

            // ä¿®å¤ï¼šé‡ç½®è¿›åº¦çŠ¶æ€ï¼Œé˜²æ­¢æ®‹ç•™
            UI.progressBar.value = 0;
            UI.progressBar.max = state.images.length; // å…³é”®ä¿®å¤ï¼šè®¾ç½®æœ€å¤§å€¼
            UI.progressPercent.innerText = "0%";
            UI.progressFilename.innerText = "åˆå§‹åŒ–...";

            const theadRow = document.createElement('tr');
            theadRow.innerHTML = `<th>æ–‡ä»¶å</th>` + state.fields.map(f => `<th>${f}</th>`).join('');
            document.getElementById('resultHead').innerHTML = '';
            document.getElementById('resultHead').appendChild(theadRow);
            document.getElementById('resultBody').innerHTML = '';
            state.results = [];

            try {
                const lang = document.getElementById('langSelect').value;
                UI.progressStatus.innerText = "åˆå§‹åŒ–å¼•æ“...";
                const worker = await Tesseract.createWorker(lang);
                let total = state.images.length, current = 0;

                for (let groupKey in state.groups) {
                    const images = state.groups[groupKey];
                    const template = state.templates[groupKey];
                    if (!template || Object.keys(template).length === 0) continue;

                    for (let imgObj of images) {
                        // æ›´æ–°è¿›åº¦æ¡
                        UI.progressBar.value = current;
                        UI.progressPercent.innerText = Math.round((current / total) * 100) + "%";
                        UI.progressStatus.innerText = "æ­£åœ¨å¤„ç†...";
                        UI.progressFilename.innerText = `${imgObj.file.name}`;

                        let rowData = { filename: imgObj.file.name };
                        for (let field of state.fields) {
                            const rect = template[field];
                            if (rect) {
                                try {
                                    const { data: { text } } = await worker.recognize(imgObj.file, {
                                        rectangle: { left: rect.x, top: rect.y, width: rect.w, height: rect.h }
                                    });
                                    rowData[field] = text.replace(/\n/g, ' ').trim();
                                } catch (e) { rowData[field] = "Error"; }
                            } else { rowData[field] = ""; }
                        }
                        state.results.push(rowData);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${rowData.filename}</td>` + state.fields.map(f => `<td>${rowData[f]}</td>`).join('');
                        document.getElementById('resultBody').appendChild(tr);
                        current++;
                    }
                }
                await worker.terminate();

                // ä¿®å¤è¿›åº¦æ¡æœ€åçŠ¶æ€
                UI.progressStatus.innerText = "å®Œæˆï¼";
                UI.progressBar.value = total;
                UI.progressPercent.innerText = "100%";
                UI.progressFilename.innerText = "æ‰€æœ‰å›¾ç‰‡å¤„ç†å®Œæ¯•";

                document.getElementById('dlBtn').disabled = false;
                document.getElementById('startBtn').disabled = false;
                customAlert("å…¨éƒ¨å®Œæˆï¼");
            } catch (err) {
                console.error(err);
                customAlert("é”™è¯¯: " + err.message);
                document.getElementById('startBtn').disabled = false;
            }
        }

        function downloadCSV() {
            if (state.results.length === 0) return;
            const headers = ['Filename', ...state.fields];
            let csv = headers.join(',') + '\n';
            state.results.forEach(row => {
                csv += [row.filename, ...state.fields.map(f => {
                    let v = row[f] || '';
                    return v.includes(',') || v.includes('"') ? `"${v.replace(/"/g, '""')}"` : v;
                })].join(',') + '\n';
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = "ocr_results.csv";
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
    </script>
</body>

</html>